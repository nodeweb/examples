Vue.component("orderlist",{
  template:"#order-template",
  data() {
    return {
      multipleSelection: [],
      total:0,
      currentPage:1,
      currentNum:100,
      list:[],
      loading:false,
      formLabelWidth: '125px',
      dialogFormVisible: false,
      dialogForm2Visible: false,
      dialogForm5Visible: false,
      dialogForm6Visible: false,
      form: {
          name:'',
          public_ip:"",
          ip:""
      },
      form2: {
          name:'',
          public_ip:"",
          ip:""
      },
      form5: {
          no_server_id:'',
          l_template:''
      },
      form6: {
          no_server_id:'',
          f_template:''
      }
    }
  },
  created:function(){
      let page = this.currentPage
      let num = this.currentNum
      this.loading = true
      let that = this
      this.getData(page,num,function (res) {
          let dt = res.data
          that.list = dt.list
          that.total = dt.total
          that.loading = false
      })
  },
  methods: {
    toggleSelection: function (rows) {
      if (rows) {
        rows.forEach(row => {
          this.$refs.multipleTable.toggleRowSelection(row);
        });
      } else {
        this.$refs.multipleTable.clearSelection();
      }
    },
    handleSelectionChange: function (val) {
      console.log(val)
      this.multipleSelection = val;
    },
    handleOrder: function (val) {
      console.log("filed=", val.prop)
      console.log("type=", val.order)


      this.loading = true
      setTimeout(() => {
        this.loading = false;
      }, 2000);
    },
    handleSizeChange(val) {
      console.log(`每页 ${val} 条`);
      this.currentNum = val
      this.loading = true
      let page = this.currentPage
      let that = this

      this.getData(page, val, function (res) {
        let dt = res.data
          that.list = dt.list
          that.total = dt.total
          that.loading = false
      })

    },
    handleCurrentChange(val) {
      console.log(`当前页: ${val}`);
      this.currentPage = val
      this.loading = true
      let num = this.currentNum
      let that = this

      this.getData(val, num, function (res) {
        let dt = res.data
          that.list = dt.list
          that.total = dt.total
          that.loading = false
      })
    },
    getData: function (page, num, callback) {
      let that = this
      let href = window.location.href
      axios.post(href, {
        page: page,
        num: num,
      }).then(function (res) {
        console.log(res)
        callback(res)
      }).catch(function (e) {
          that.loading = false
          that.$message({
              message: '操作失败',
              type: 'warning'
          });
      })
    },
    getUrl:function(d){
        let href = window.location.href.split("acount")[0] + "order/" + d.id + "?acount=" + d.number;
        window.location.href = href
    },
    formatDate:function (tm) {
      let dt = moment(tm).format("YYYY-MM-DD HH:mm:ss")
      return dt
    },
    formatMoney:function (m) {
      let my = parseFloat(m/100).toFixed(2)
      return my
    },
    formatBool:function (s) {
      let m = s ? "是" : "否"
      return m
    },
    doHtml:function(d){
      let h = [
          '<div class="el-form-item">',
          '<label class="el-form-item__label">创建时间</label>',
          '<div class="el-form-item__content">',
          '<span>'+d.create_time+'</span>',
          '</div></div>',
          '<div class="el-form-item">',
          '<label class="el-form-item__label">APPID</label>',
          '<div class="el-form-item__content">',
          '<span>'+d.appid+'</span>',
          '</div></div>',
          '<div class="el-form-item">',
          '<label class="el-form-item__label">APPSECRET</label>',
          '<div class="el-form-item__content">',
          '<span>'+d.app_secret+'</span>',
          '</div></div>',
          '<div class="el-form-item">',
          '<label class="el-form-item__label">授权发起页域名</label>',
          '<div class="el-form-item__content">',
          '<span>'+d.back_host+'</span>',
          '</div></div>',
          '<div class="el-form-item">',
          '<label class="el-form-item__label">授权公众号</label>',
          '<div class="el-form-item__content">',
          '<span>'+d.wechat_id+'</span>',
          '</div></div>',
          '<div class="el-form-item">',
          '<label class="el-form-item__label">授权事件接收URL</label>',
          '<div class="el-form-item__content">',
          '<span>'+d.back_url+'</span>',
          '</div></div>',
          '<div class="el-form-item">',
          '<label class="el-form-item__label">消息校验Token</label>',
          '<div class="el-form-item__content">',
          '<span>'+d.msg_token+'</span>',
          '</div></div>',
          '<div class="el-form-item">',
          '<label class="el-form-item__label">消息加解密Key</label>',
          '<div class="el-form-item__content">',
          '<span>'+d.encodingAESKey+'</span>',
          '</div></div>',
          '<div class="el-form-item">',
          '<label class="el-form-item__label">分享页域名</label>',
          '<div class="el-form-item__content">',
          '<span>'+d.one_url+'</span>',
          '</div></div>',
          '<div class="el-form-item">',
          '<label class="el-form-item__label">入口页域名1</label>',
          '<div class="el-form-item__content">',
          '<span>'+d.two_url+'</span>',
          '</div></div>',
          '<div class="el-form-item">',
          '<label class="el-form-item__label">入口页域名2</label>',
          '<div class="el-form-item__content">',
          '<span>'+d.three_url+'</span>',
          '</div></div>',
      ].join('')
      return h;
    },
    goAuth: function (id) {
        let that = this
        let href = window.location.href.split("?")[0] + "/doHref"
        axios.post(href, {appid:id}).then(function (res) {
            console.log(res)
            let dt = res.data

            that.$alert('获取授权成功', '', {
                confirmButtonText: '前往授权',
                center: true,
                callback: action => {
                    if(action=="confirm") {
                        window.open(dt.url)
                    }
                }
            });

        }).catch(function (e) {
            that.$message({
                type: 'info',
                message: '获取授权失败'
            });
        })
    },
    postDate:function (d) {
        let that = this
        this.loading = true
        let href = window.location.href.split("?")[0] + "/doApp"
        axios.post(href,d).then(function (res) {
            let dt = res.data
            that.loading = false
            that.dialogFormVisible = false
            that.$message({
                message: '新建应用成功',
                type: 'success'
            });
            window.location.reload()
        }).catch(function (e) {
            that.loading = false
            that.dialogFormVisible = false
            that.$message({
                message: '新建应用失败',
                type: 'warning'
            });
        })
    },

    post5:function (d) {
      let that = this
      this.loading = true
      let href = window.location.href.split("?")[0] + "/chgHtml"
      axios.post(href,d).then(function (res) {
          let dt = res.data
          that.loading = false
          that.dialogForm5Visible = false
          if(dt.code == 0) {
              that.$message({
                  message: '修改模版成功',
                  type: 'success'
              });
          } else {
              that.$message({
                  message: '修改模版失败',
                  type: 'warning'
              });
          }
      }).catch(function (e) {
          that.loading = false
          that.dialogForm5Visible = false
          that.$message({
              message: '修改模版失败',
              type: 'warning'
          });
      })
    },
    post6:function (d) {
      let that = this
      this.loading = true
      let href = window.location.href.split("?")[0] + "/chgHtml"
      axios.post(href,d).then(function (res) {
          let dt = res.data
          that.loading = false
          that.dialogForm6Visible = false
          if(dt.code == 0) {
              that.$message({
                  message: '修改模版成功',
                  type: 'success'
              });
          } else {
              that.$message({
                  message: '修改模版失败',
                  type: 'warning'
              });
          }
      }).catch(function (e) {
          that.loading = false
          that.dialogForm6Visible = false
          that.$message({
              message: '修改模版失败',
              type: 'warning'
          });
      })
    },

    chgStatu: function (id) {
        let that = this
        this.loading = true
        let href = window.location.href.split("?")[0] + "/chgstatu"
        axios.post(href,{appid:id}).then(function (res) {
            let dt = res.data
            that.loading = false
            that.$message({
                message: '应用已禁用',
                type: 'success'
            });
            window.location.reload()
        }).catch(function (e) {
            that.loading = false
            that.$message({
                message: '操作失败',
                type: 'warning'
            });
        })
    },
    chgIp:function (d) {
        let that = this
        this.form2.ip = d.ip;
        this.form2.public_ip = d.public_ip
        this.dialogForm2Visible = true
    },
    chgGame:function (d) {
      let that = this
      this.form5.no_server_id = d.id;
      this.form5.l_template = d.l_template;
      this.dialogForm5Visible = true
    },
    chgShare:function (d) {
      let that = this
      this.form6.no_server_id = d.id;
      this.form6.f_template = d.f_template;
      this.dialogForm6Visible = true
    },
    post2Date:function (d) {
        let that = this
        this.loading = true
        let href = window.location.href.split("?")[0] + "/chgwechat"
        axios.post(href,{appid:d.appid,wechat_id:d.wechat_id}).then(function (res) {
            let dt = res.data
            that.dialogForm2Visible = false
            that.loading = false
            that.$message({
                message: '公众号信息修改成功',
                type: 'success'
            });
            window.location.reload()
        }).catch(function (e) {
            that.loading = false
            that.$message({
                message: '操作失败',
                type: 'warning'
            });
        })
    },
    mkText:function (d) {
        let that = this
        this.loading = true
        let href = window.location.href.split("?")[0] + "/mkText"
        axios.post(href,d).then(function (res) {
            let dt = res.data
            that.dialogForm2Visible = false
            that.loading = false
            that.$message({
                message: '生成Text文件成功',
                type: 'success'
            });
        }).catch(function (e) {
            that.loading = false
            that.$message({
                message: '生成Text文件失败',
                type: 'warning'
            });
        })
    },
  }
})


